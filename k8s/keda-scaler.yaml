# KEDA ScaledObject - Azure Event Hubs 기반 오토스케일링
#
# 두 가지 모드 지원:
#   1. 로컬 테스트: Prometheus 메트릭 기반
#   2. Azure 운영: Event Hubs Lag 기반
#
# 배포:
#   kubectl apply -f keda-scaler.yaml

---
# ============================================
# 모드 1: 로컬 테스트용 (Prometheus 기반)
# ============================================
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: log-analyzer-scaler-local
  labels:
    app: log-analyzer
    mode: local
spec:
  scaleTargetRef:
    name: log-analyzer
    kind: SpinApp
    apiVersion: core.spinkube.dev/v1alpha1

  minReplicaCount: 1
  maxReplicaCount: 10
  cooldownPeriod: 30
  pollingInterval: 5

  triggers:
    - type: prometheus
      metadata:
        serverAddress: http://prometheus-kube-prometheus-prometheus.monitoring:9090
        metricName: http_requests_total
        query: |
          sum(rate(http_requests_total{service="log-analyzer-svc"}[1m]))
        threshold: "100"

---
# ============================================
# 모드 2: Azure 운영용 (Event Hubs 기반)
# ============================================
# 아래 설정은 Azure 배포 시 활성화하세요.
#
# apiVersion: keda.sh/v1alpha1
# kind: ScaledObject
# metadata:
#   name: log-analyzer-scaler-eventhub
#   labels:
#     app: log-analyzer
#     mode: azure
# spec:
#   scaleTargetRef:
#     name: log-analyzer
#     kind: SpinApp
#     apiVersion: core.spinkube.dev/v1alpha1
#
#   minReplicaCount: 1
#   maxReplicaCount: 50
#   cooldownPeriod: 60
#   pollingInterval: 10
#
#   triggers:
#     - type: azure-eventhub
#       metadata:
#         # Event Hub 설정
#         eventHubNamespace: spinkube-iot-dev-ehns
#         eventHubName: iot-log-stream
#         consumerGroup: keda-consumer
#         # 파티션당 처리 대기 메시지 임계값
#         unprocessedEventThreshold: "64"
#         # Blob Storage (체크포인트용)
#         blobContainer: eventhub-checkpoints
#       authenticationRef:
#         name: keda-eventhub-auth

---
# ============================================
# Azure Event Hubs 인증 설정
# ============================================
# apiVersion: keda.sh/v1alpha1
# kind: TriggerAuthentication
# metadata:
#   name: keda-eventhub-auth
# spec:
#   secretTargetRef:
#     - parameter: connection
#       name: eventhub-secrets
#       key: connection-string
#     - parameter: storageConnection
#       name: eventhub-secrets
#       key: storage-connection-string

---
# ============================================
# Event Hubs 연결 정보 Secret
# ============================================
# apiVersion: v1
# kind: Secret
# metadata:
#   name: eventhub-secrets
# type: Opaque
# stringData:
#   connection-string: "Endpoint=sb://spinkube-iot-dev-ehns.servicebus.windows.net/;SharedAccessKeyName=keda-auth;SharedAccessKey=xxx;EntityPath=iot-log-stream"
#   storage-connection-string: "DefaultEndpointsProtocol=https;AccountName=xxx;AccountKey=xxx;EndpointSuffix=core.windows.net"

---
# ============================================
# 모드 3: Cron 기반 스케일링 (테스트용)
# ============================================
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: log-analyzer-scaler-cron
  labels:
    app: log-analyzer
    mode: cron-test
spec:
  scaleTargetRef:
    name: log-analyzer
    kind: SpinApp
    apiVersion: core.spinkube.dev/v1alpha1

  minReplicaCount: 0
  maxReplicaCount: 5

  triggers:
    - type: cron
      metadata:
        timezone: Asia/Seoul
        start: "0 * * * *"
        end: "30 * * * *"
        desiredReplicas: "5"
